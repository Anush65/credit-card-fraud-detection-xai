{% extends "base.html" %}

{% block content %}
<section class="prediction-section">
    <div class="prediction-header">
        <h2>Transaction Analyzer</h2>
        <p>Enter variable parameters to detect probability of fraud.</p>
    </div>

    <div class="tool-container">
        <div class="controls">
            <button type="button" class="autofill-btn fraud-btn" onclick="fillFraudSample()"><i
                    class="fas fa-exclamation-triangle"></i> Load Fraud Scenario</button>
            <button type="button" class="autofill-btn safe-btn" onclick="fillNormalSample()"><i
                    class="fas fa-check-circle"></i> Load Safe Scenario</button>
        </div>

        <form id="predictionForm" class="modern-form">
            <div class="input-grid">
                <div class="input-group">
                    <label for="Time">Time (sec) <span class="tooltip"
                            title="Seconds elapsed since first transaction">?</span></label>
                    <input type="number" id="Time" name="Time" required placeholder="0">
                </div>
                <div class="input-group">
                    <label for="Amount">Amount ($)</label>
                    <input type="number" step="0.01" id="Amount" name="Amount" required placeholder="0.00">
                </div>
                <div class="input-group">
                    <label for="V4">V4 (PCA)</label>
                    <input type="number" step="0.0001" id="V4" name="V4" required>
                </div>
                <div class="input-group">
                    <label for="V10">V10 (PCA)</label>
                    <input type="number" step="0.0001" id="V10" name="V10" required>
                </div>
                <div class="input-group">
                    <label for="V12">V12 (PCA)</label>
                    <input type="number" step="0.0001" id="V12" name="V12" required>
                </div>
                <div class="input-group">
                    <label for="V14">V14 (PCA)</label>
                    <input type="number" step="0.0001" id="V14" name="V14" required>
                </div>
                <div class="input-group">
                    <label for="V17">V17 (PCA)</label>
                    <input type="number" step="0.0001" id="V17" name="V17" required>
                </div>
                <div class="input-group">
                    <label for="V18">V18 (PCA)</label>
                    <input type="number" step="0.0001" id="V18" name="V18" required>
                </div>
            </div>

            <button type="submit" class="predict-btn">
                <span class="btn-text">Analyze Transaction</span>
                <i class="fas fa-microchip"></i>
            </button>
        </form>

        <section id="resultSection" class="result-card hidden">
            <div class="result-header">
                <h3>Analysis Report</h3>
            </div>
            <div id="resultContent">
                <!-- Results will appear here -->
            </div>
        </section>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    // Scenarios for Random Selection
    const fraudScenarios = [
        { Time: 406, Amount: 0.00, V4: 4.8, V10: -5.6, V12: -6.1, V14: -6.8, V17: -11.6, V18: -4.5 },
        { Time: 472, Amount: 1.00, V4: 3.7, V10: -2.9, V12: -4.2, V14: -5.1, V17: -8.3, V18: -3.2 }, // "Testing" Charge
        { Time: 11000, Amount: 999.99, V4: 6.2, V10: -7.5, V12: -8.5, V14: -9.1, V17: -15.2, V18: -6.4 }, // Major Theft
        { Time: 8520, Amount: 5.00, V4: 2.9, V10: -3.8, V12: -4.0, V14: -4.5, V17: -6.2, V18: -2.1 }
    ];

    const safeScenarios = [
        { Time: 1000, Amount: 100.00, V4: 0.5, V10: 0.1, V12: 0.2, V14: 0.3, V17: 0.1, V18: 0.0 }, // Standard Purchase
        { Time: 3500, Amount: 12.50, V4: -0.2, V10: 0.5, V12: -0.1, V14: 0.1, V17: -0.2, V18: 0.1 }, // Small Coffee
        { Time: 28000, Amount: 1500.00, V4: 0.1, V10: 0.9, V12: 0.5, V14: 0.2, V17: 0.4, V18: -0.1 }, // Rent/Bill (High Amt but Normal V-feats)
        { Time: 500, Amount: 45.00, V4: -0.5, V10: -0.1, V12: 0.3, V14: -0.2, V17: 0.2, V18: 0.1 }
    ];

    function fillFraudSample() {
        const scenario = fraudScenarios[Math.floor(Math.random() * fraudScenarios.length)];
        fillForm(scenario);
    }

    function fillNormalSample() {
        const scenario = safeScenarios[Math.floor(Math.random() * safeScenarios.length)];
        fillForm(scenario);
    }

    function fillForm(data) {
        document.getElementById('Time').value = data.Time;
        document.getElementById('Amount').value = data.Amount;
        document.getElementById('V4').value = data.V4;
        document.getElementById('V10').value = data.V10;
        document.getElementById('V12').value = data.V12;
        document.getElementById('V14').value = data.V14;
        document.getElementById('V17').value = data.V17;
        document.getElementById('V18').value = data.V18;

        document.getElementById('predictionForm').scrollIntoView({ behavior: 'smooth' });

        // Visual feedback
        const inputs = document.querySelectorAll('#predictionForm input');
        inputs.forEach(input => {
            input.style.backgroundColor = '#e8f0fe';
            setTimeout(() => input.style.backgroundColor = '', 500);
        });
    }

    document.getElementById('predictionForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const btn = document.querySelector('.predict-btn');
        const origText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
        btn.disabled = true;

        const formData = new FormData(this);
        try {
            const response = await fetch('/predict', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            const resultDiv = document.getElementById('resultSection');
            const contentDiv = document.getElementById('resultContent');

            resultDiv.classList.remove('hidden');
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });

            if (result.error) {
                contentDiv.innerHTML = `<p class="error-msg"><i class="fas fa-times-circle"></i> ${result.error}</p>`;
            } else {
                let isFraud = result.result === 'Fraud';
                let colorClass = isFraud ? 'fraud-result' : 'safe-result';
                let icon = isFraud ? 'fa-exclamation-circle' : 'fa-check-shield';

                let explainHtml = '<div class="factors-list"><h4>Key Contributing Factors:</h4><ul>';
                result.top_features.forEach(f => {
                    explainHtml += `
                        <li>
                            <div class="factor-row">
                                <span class="factor-name">${f.feature}</span>
                                <span class="factor-val">Val: ${f.value}</span>
                                <div class="factor-bar-bg">
                                    <div class="factor-bar" style="width: ${Math.min(f.importance * 100 * 2, 100)}%"></div>
                                </div>
                            </div>
                        </li>`;
                });
                explainHtml += '</ul></div>';

                contentDiv.innerHTML = `
                    <div class="status-badge ${colorClass}">
                        <i class="fas ${icon}"></i>
                        <span>${result.result.toUpperCase()}</span>
                    </div>
                    <div class="confidence-meter">
                        <p>Confidence Level: <strong>${result.confidence}%</strong></p>
                        <div class="meter-bg">
                            <div class="meter-fill ${colorClass}-bg" style="width: ${result.confidence}%"></div>
                        </div>
                    </div>
                    ${explainHtml}
                `;
            }
        } catch (err) {
            console.error(err);
            alert('An error occurred during prediction.');
        } finally {
            btn.innerHTML = origText;
            btn.disabled = false;
        }
    });
</script>
{% endblock %}